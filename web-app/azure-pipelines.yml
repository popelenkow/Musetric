trigger:
  branches:
    include:
    - develop
    - release/v*
  paths:
    include:
    - 'web-app/*'

parameters:
- name: tag
  displayName: tag
  type: string
  values:
  - next
  - beta
  - latest
  default: next
- name: isDockerPublish
  type: boolean
  default: false
- name: isGithubPublish
  type: boolean
  default: false

variables:
  - name: root
    value: web-app
  - group: AccessTokens

pool:
  vmImage: 'ubuntu-16.04'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '12.18.4'
  displayName: 'node.js 12.18.4'

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.7'
  displayName: 'python 3.7'

- task: PythonScript@0
  inputs:
    scriptSource: inline
    script: |
      import json
      with open('package.json') as json_file:
        rawVersion = json.load(json_file)['version']

      isReleaseBranch = '$(Build.SourceBranch)'.startswith('refs/heads/release')
      print(f'isReleaseBranch {isReleaseBranch}')

      tag = f'${{parameters.tag}}'
      print(f'##vso[task.setvariable variable=tag]{tag}')
      print(f'tag {tag}')

      if tag == 'latest':
        version = rawVersion
      elif tag == 'beta':
        version = f'{rawVersion}-beta.$(Build.BuildID)'
      else:
        version = f'{rawVersion}-dev.$(Build.BuildID)'
      print(f'##vso[task.setvariable variable=version]{version}')
      print(f'version {version}')

      isDockerPublish = ${{parameters.isDockerPublish}}
      print(f'##vso[task.setvariable variable=isDockerPublish]{isDockerPublish}')
      print(f'isDockerPublish {isDockerPublish}')

      if tag == 'latest':
        isGithubRelease = True
      else:
        isGithubRelease = False
      print(f'##vso[task.setvariable variable=isGithubRelease]{isGithubRelease}')
      print(f'isGithubRelease {isGithubRelease}')
    workingDirectory: $(root)
  displayName: 'init variables'

- script: yarn version --new-version $(version) --no-git-tag-version
  workingDirectory: $(root)
  displayName: 'yarn version'

- script: yarn --ignore-scripts
  workingDirectory: $(root)
  displayName: 'yarn'

- script: yarn lint
  workingDirectory: $(root)
  displayName: 'yarn lint'

- script: yarn build
  workingDirectory: $(root)
  displayName: 'yarn build'

- script: docker build -t popelenkow/musetric:v$(version) .
  workingDirectory: $(root)
  displayName: 'docker build'

- script: docker login --username popelenkow --password $(dockerToken)
  condition: and(succeeded(), eq(variables.isDockerPublish, true))
  displayName: 'docker login'

- script: docker push popelenkow/musetric
  condition: and(succeeded(), eq(variables.isDockerPublish, true))
  displayName: 'docker push'

- script: yarn pack
  workingDirectory: $(root)/dist
  condition: and(succeeded(), eq(variables.isGithubPublish, true))
  displayName: 'yarn pack'

- task: GitHubRelease@1
  inputs:
    title: musetric $(version)
    gitHubConnection: githubToken
    tagSource: userSpecifiedTag
    tag: v$(version)
    assets: '$(root)/dist/*.tgz'
    isDraft: true
    isPreRelease: $(isRelease)
  condition: and(succeeded(), eq(variables.isGithubPublish, true))
  displayName: 'github publish'